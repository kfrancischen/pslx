



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
        <meta name="author" content="Kaifeng Chen">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>Data Storage - PSLX documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.adb8469c.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#default-storage-documentation" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="PSLX documentation" aria-label="PSLX documentation" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              PSLX documentation
            </span>
            <span class="md-header-nav__topic">
              
                Data Storage
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/kfrancischen/pslx/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    kfrancischen/pslx
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="PSLX documentation" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    PSLX documentation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/kfrancischen/pslx/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    kfrancischen/pslx
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../websocket/" title="Websocket" class="md-nav__link">
      Websocket
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../container/" title="Job Scheduling" class="md-nav__link">
      Job Scheduling
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Data Storage
      </label>
    
    <a href="./" title="Data Storage" class="md-nav__link md-nav__link--active">
      Data Storage
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#default-storage-documentation" class="md-nav__link">
    Default Storage Documentation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fixed-size-storage-documentation" class="md-nav__link">
    Fixed Size Storage Documentation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proto-table-storage" class="md-nav__link">
    Proto Table Storage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sharded-proto-table-storage" class="md-nav__link">
    Sharded Proto Table Storage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#partitioner-storage" class="md-nav__link">
    Partitioner Storage
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../rpc/" title="RPC" class="md-nav__link">
      RPC
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Micro Services
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Micro Services
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../micro_services/instant_messaging/" title="Instant Messaging" class="md-nav__link">
      Instant Messaging
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../micro_services/email/" title="Email" class="md-nav__link">
      Email
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../micro_services/message_queue/" title="Message Queue" class="md-nav__link">
      Message Queue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../micro_services/pubsub/" title="Publisher/Subscriber" class="md-nav__link">
      Publisher/Subscriber
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../micro_services/frontend/" title="PSLX frontend" class="md-nav__link">
      PSLX frontend
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tool/" title="Tools" class="md-nav__link">
      Tools
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../util/" title="Utilities" class="md-nav__link">
      Utilities
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../schema/" title="Proto Schema" class="md-nav__link">
      Proto Schema
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#default-storage-documentation" class="md-nav__link">
    Default Storage Documentation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fixed-size-storage-documentation" class="md-nav__link">
    Fixed Size Storage Documentation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proto-table-storage" class="md-nav__link">
    Proto Table Storage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sharded-proto-table-storage" class="md-nav__link">
    Sharded Proto Table Storage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#partitioner-storage" class="md-nav__link">
    Partitioner Storage
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/kfrancischen/pslx/edit/master/docs/storage.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Data Storage</h1>
                
                <p>PSLX supports in total five different types of storage: <code>StorageType.DEFAULT_STORAGE</code>, <code>StorageType.FIXED_SIZE_STORAGE</code>,
<code>StorageType.PROTO_TABLE_STORAGE</code>, <code>StorageType.SHARDED_PROTO_TABLE_STORAGE</code> and <code>StorageType.PARTITIONER_STORAGE</code>, and the <code>StorageType.PARTITIONER_STORAGE</code> also support
five different types of timestamp based partitions: <code>PartitionerStorageType.MINUTELY</code>, <code>PartitionerStorageType.HOURLY</code>, <code>PartitionerStorageType.DAILY</code>,
<code>PartitionerStorageType.MONTHLY</code>, <code>PartitionerStorageType.YEARLY</code>. The related enums are defined in <a href="../schema/">schema</a>, and their implementations are
in the <a href="https://github.com/kfrancischen/pslx/tree/master/pslx/storage">storage</a> folder.</p>
<p>The four stage all inherit from a parent class and <a href="https://github.com/kfrancischen/pslx/blob/master/pslx/storage/storage_base.py"><code>storage_base.py</code></a>, where
each inheritance needs to implement its own read and write functions. Besides these two functions, there are a few functions
that are shard across all storage types.</p>
<div class="codehilite"><pre><span></span><code><span class="fm">__init__</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Construct a storage.</li>
<li>Arguments:<ol>
<li>logger: the logger. Default value is None.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">set_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Updates the initial config.</li>
<li>Arguments:<ol>
<li>config: the config that is added to the existing config.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">get_storage_type</span><span class="p">()</span>
</code></pre></div>


<ul>
<li>Description: Get the storage type of the storage.</li>
<li>Return: the storage type of the storage, one of <code>StorageType.DEFAULT_STORAGE</code>, <code>StorageType.FIXED_SIZE_STORAGE</code>,
<code>StorageType.PROTO_TABLE_STORAGE</code> and <code>StorageType.PARTITIONER_STORAGE</code>.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">initialize_from_file</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: initialize the storage from a file, only supported by <code>StorageType.DEFAULT_STORAGE</code>, <code>StorageType.FIXED_SIZE_STORAGE</code>,
and <code>StorageType.PROTO_TABLE_STORAGE</code>.</li>
<li>Arguments:<ol>
<li>file_name: the file that is used to initialize the storage.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">initialize_from_dir</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: initialize the storage from a directory, only supported by <code>StorageType.PARTITIONER_STORAGE</code>.</li>
<li>Arguments:<ol>
<li>dir_name: the directory name that is used to initialize the storage.</li>
</ol>
</li>
</ul>
<h3 id="default-storage-documentation">Default Storage Documentation<a class="headerlink" href="#default-storage-documentation" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">read</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Read from the storage.</li>
<li>Arguments:<ol>
<li>params: the read parameters.</li>
</ol>
</li>
<li>Explanation:<ol>
<li>The underlying file needs to be a text file, and the default storage supports read/write from both top and down (see
the definition of <code>ReadRuleType</code> and <code>WriteRuleType</code> in <a href="../schema/">schema</a>), and can be set by function <code>set_config(config)</code>
by overwriting string <code>read_rule_type</code> and <code>write_rule_type</code> with the correct enum. The default values for them are <code>ReadRuleType.READ_FROM_BEGINNING</code> and
<code>WriteRuleType.WRITE_FROM_END</code>.</li>
<li>The params in the <code>read(params)</code> function supports the number of lines to read from the file. The way to set this field is
to pass <code>num_line</code> to the param (a dictionary). If the <code>num_line</code> exceeds the total number of lines in the file, an error will be raised.</li>
<li>After reading the underlying file, the file handler will move accordingly. For example, after reading one line from the file, the second time
the storage will start by reading the second line of the file. The can be reset by calling <code>start_from_first_line()</code>.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Write to the storage.</li>
<li>Arguments:<ol>
<li>data: the write parameters.</li>
</ol>
</li>
<li>Explanation:<ol>
<li>If the data is a string, it will be written to the underlying file from top or bottom depending on the value of <code>write_rule_type</code>.</li>
<li>If the data is a list, it will be joined with <code>delimter</code> set in the params. If key <code>delimiter</code> is not present in params, comma will be used by default.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">start_from_first_line</span><span class="p">()</span>
</code></pre></div>


<ul>
<li>Description: Reset the reader to read from the first line (from top or bottom).</li>
</ul>
<h3 id="fixed-size-storage-documentation">Fixed Size Storage Documentation<a class="headerlink" href="#fixed-size-storage-documentation" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="fm">__init__</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fixed_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Overrides the default constructor.</li>
<li>Arguments:<ol>
<li>logger: the logger. Default value is None.</li>
<li>fixed_size: the maximum data size that this storage will hold in memory, negative meaning the maximum size is infinity.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">read</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Read from the storage.</li>
<li>Arguments:<ol>
<li>params: the read parameters.</li>
</ol>
</li>
<li>Explanation:<ol>
<li>Like the default storage, the underlying file needs to be a text file. The difference between fixed size storage and default storage
is that fixed size storage will hold data in memory (while default storage will by default read the underlying file). The params supported here are <code>num_line</code>
and <code>force_load</code>. <code>num_line</code> indicates the number of lines to read. If <code>force_load</code> if False and the <code>num_lines</code> exceeds the internal maximum
size, error will be raised. If <code>force_load</code> is true, the storage will search for the file.</li>
<li>Due to the nature of the fixed size storage, it could be used a buffer storage between disk and application.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Write to the storage.</li>
<li>Arguments:<ol>
<li>data: the write parameters.</li>
</ol>
</li>
<li>Explanation:<ol>
<li>Same as the writer implementation of default storage.</li>
</ol>
</li>
</ul>
<h3 id="proto-table-storage">Proto Table Storage<a class="headerlink" href="#proto-table-storage" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="n">read</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Read from the storage.</li>
<li>Arguments:<ol>
<li>params: the read parameters.</li>
</ol>
</li>
<li>Explanation:<ol>
<li>proto table is a key-value storage, and therefore the params need to contain field of <code>key</code>.</li>
<li>The value of the proto table is a proto message, and if the field of <code>message_type</code> is provided,
 the reader will correctly deserialize to the desired protobuf. Otherwise it will only an <code>Any</code> type message.</li>
<li>Under PSLX convention, the underlying file name needs to end with <code>.pb</code>.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">read_all</span><span class="p">()</span>
</code></pre></div>


<ul>
<li>Description: Read all the data.</li>
<li>Return: the key, value dictionary of the table, with value being the <code>Any</code> proto format.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Write to the storage.</li>
<li>Arguments:<ol>
<li>data: the write parameters.</li>
</ol>
</li>
<li>Explanation:<ol>
<li>The data needs to be a dictionary of <code>key, value</code> with key being a string and value being a protobuf message of any user defined
types.</li>
<li>The params can contain <code>overwrite</code> with its value a boolean indicating whether to overwrite the value if the key already
exists in the proto table.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Delete key and the corresponding entry from the proto table.</li>
<li>Arguments:<ol>
<li>key: the key of the entry to be deleted.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">delete_all</span><span class="p">()</span>
</code></pre></div>


<ul>
<li>Description: Delete all the contents from the proto table.</li>
</ul>
<h3 id="sharded-proto-table-storage">Sharded Proto Table Storage<a class="headerlink" href="#sharded-proto-table-storage" title="Permanent link">&para;</a></h3>
<p>Sharded proto table storage will shard the data into different proto tables, denoted by <code>data@SHARD.pb</code>, where the <code>SHARD</code> is an integer that starts from <code>0</code>. In addition to these tables, there also exists a <code>index_map.pb</code> protobuf that stores the metadata information such as the mapping between each key and the shard that it belongs to, the latest shard, and the maximum size per shard.</p>
<div class="codehilite"><pre><span></span><code><span class="fm">__init__</span><span class="p">(</span><span class="n">size_per_shard</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: To initialize a sharded proto table storage with <code>size_per_shard</code> for each shard.</li>
<li>Arguments:<ol>
<li>size_per_shard: the size per shard. This has to be set if the sharded proto table is newly created, and can be set <code>None</code> if the table already exists.</li>
<li>logger: please see the <code>storage_base</code> definition.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">read</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Read from the storage.</li>
<li>Arguments:<ol>
<li>params: the read parameters.</li>
</ol>
</li>
<li>Explanation:<ol>
<li>proto table is a key-value storage, and therefore the params need to contain field of <code>keys</code>, which is a list of keys in the storage.</li>
</ol>
</li>
<li>Return: a dictionary of key-values, where keys might be a subset of the input keys in the params for which the key exists in the sharded proto table storage.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">read_all</span><span class="p">()</span>
</code></pre></div>


<ul>
<li>Description: Read all the data from the storage</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Write to the storage.</li>
<li>Arguments:<ol>
<li>data: the write parameters.</li>
</ol>
</li>
<li>Explanation:<ol>
<li>The data needs to be a dictionary of <code>key, value</code> with key being a string and value being a protobuf message of any user defined
types.</li>
<li>The params can contain <code>overwrite</code> with its value a boolean indicating whether to overwrite the value if the key already
exists in the proto table.</li>
</ol>
</li>
</ul>
<h3 id="partitioner-storage">Partitioner Storage<a class="headerlink" href="#partitioner-storage" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The base class implementation of partitioners is in <a href="https://github.com/kfrancischen/pslx/blob/master/pslx/storage/partitioner_base.py">partitioner_base.py</a>,
it uses an underlying tree structure defined in <a href="https://github.com/kfrancischen/pslx/blob/master/pslx/core/tree_base.py">tree_base.py</a>.</p>
</div>
<p>In PSLX, five types of partitioners are supported:
1. <code>PartitionerStorageType.MINUTELY</code>: the underlying directory will be format of <code>2020/03/01/00/59/</code>.
2. <code>PartitionerStorageType.HOURLY</code>:  the underlying directory will be format of <code>2020/03/01/00/</code>.
3. <code>PartitionerStorageType.DAILY</code>:  the underlying directory will be format of <code>2020/03/01/</code>.
4. <code>PartitionerStorageType.MONTHLY</code>: the underlying directory will be format of <code>2020/03/</code>.
5. <code>PartitionerStorageType.YEARLY</code> the underlying directory will be format of <code>2020/</code>.</p>
<p>All the partitioners share with the following functions. The choice of partition type would depend on the data size. It is recommended
that if the data size is huge, a more fine grained storage (<code>PartitionerStorageType.MINUTELY</code>) is used, and vice versa.</p>
<div class="codehilite"><pre><span></span><code><span class="n">set_underlying_storage</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Set underlying storage behind the partitioner.</li>
<li>Arguments:<ol>
<li>storage: any storage among <code>StorageType.DEFAULT_STORAGE</code>, <code>StorageType.FIXED_SIZE_STORAGE</code>,
 and <code>StorageType.PROTO_TABLE_STORAGE</code>.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">set_max_capacity</span><span class="p">(</span><span class="n">max_capacity</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Set the maximum capacity of the partitioner.</li>
<li>Arguments:<ol>
<li>max_capacity: the maximum capacity (number of file nodes) stored in the partitioner, negative meaning the partitioner
will store all the file nodes.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">set_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Set the config for the underlying storage.</li>
<li>Arguments:<ol>
<li>config: the config that is added to the existing config of the underlying storage.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">get_dir_name</span><span class="p">()</span>
</code></pre></div>


<ul>
<li>Description: Get the directory name that the partitioner is initialized from.</li>
<li>Return: the directory name.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">get_size</span><span class="p">()</span>
</code></pre></div>


<ul>
<li>Description: Get the current size of the partitioner file tree.</li>
<li>Return: the size of the partitioner</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">is_empty</span><span class="p">()</span>
</code></pre></div>


<ul>
<li>Description: Check whether the partitioner is empty (no files).</li>
<li>Return: True if empty and False otherwise.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">get_dir_in_timestamp</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Get the timestamp of the directory within the partitioner.</li>
<li>Arguments:<ol>
<li>dir_name: the directory name.</li>
</ol>
</li>
<li>Return: The formatted datetime object.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">get_latest_dir</span><span class="p">()</span>
</code></pre></div>


<ul>
<li>Description: Get latest directory in timestamp contained in the partitioner.</li>
<li>Return: The latest directory.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">get_oldest_dir</span><span class="p">()</span>
</code></pre></div>


<ul>
<li>Description: Get oldest directory in timestamp contained in the partitioner.</li>
<li>Return: The oldest directory.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">get_previous_dir</span><span class="p">(</span><span class="n">cur_dir</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Get the previous directory with respect to the current directory.</li>
<li>Arguments:<ol>
<li>cur_dir: the current directory</li>
</ol>
</li>
<li>Return: The previous directory if exists, otherwise None.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">get_next_dir</span><span class="p">(</span><span class="n">cur_dir</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Get the next directory with respect to the current directory.</li>
<li>Arguments:<ol>
<li>cur_dir: the current directory</li>
</ol>
</li>
<li>Return: The next directory if exists, otherwise None.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">read</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Read from the latest file in the storage.</li>
<li>Arguments:<ol>
<li>params: the read parameters.</li>
</ol>
</li>
<li>Explanation:<ol>
<li>The underlying storage might prefer a different file name stored in each partition, hence <code>base_name</code> is an arg in
params. The default <code>base_name</code> is <code>data</code> for <code>StorageType.DEFAULT_STORAGE</code> and <code>StorageType.FIXED_SIZE_STORAGE</code>, and <code>data.pb</code> for
<code>StorageType.PROTO_TABLE_STORAGE</code>. One can also set <code>reinitialize_underlying_storage</code> if one wants the storage
to be reinitialized.</li>
<li>The read only load data from the latest directory.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">read_range</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Read a range of files from the storage.</li>
<li>Arguments:<ol>
<li>params: the read parameters.</li>
</ol>
</li>
<li>Explanation:<ol>
<li>The params must contain <code>start_time</code> and <code>end_time</code> in order for the partitioner to retrieve files
with partition within the given time range. The interval is a close interval.</li>
<li>The return from this function will be a dictionary with file name as the key and file content
as the value.</li>
<li>If the underlying storage is a proto table, the value in the output dict will be in the format of
<code>{key_1: val_1, ... ..., key_n: val_n}</code> with all the <code>val_i</code> being an <code>Any</code> type message.</li>
</ol>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</code></pre></div>


<ul>
<li>Description: Write to the storage.</li>
<li>Arguments:<ol>
<li>data: the write parameters.</li>
</ol>
</li>
<li>Explanation:<ol>
<li>The underlying storage might prefer a different file name stored in each partition, hence <code>base_name</code> is an arg in
params. The default <code>base_name</code> is <code>data</code> for <code>StorageType.DEFAULT_STORAGE</code> and <code>StorageType.FIXED_SIZE_STORAGE</code>, and <code>data.pb</code> for
<code>StorageType.PROTO_TABLE_STORAGE</code>.</li>
<li>If <code>make_partition</code> is in the params and it is set False, the partition will not make new partition for the new incoming data,
otherwise (<code>make_partition</code> unset or set True), it will make partition based on the current timestamp. If an extra <code>timezone</code> field is set,
the partitioner will make a new partition based on the timezone. Possible <code>timezone</code> could be <code>PST</code>, <code>EST</code> or <code>UTC</code>. If not set, the default
time zone is <code>PST</code>.</li>
</ol>
</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Debug only.</p>
</div>
<div class="codehilite"><pre><span></span><code><span class="n">print_self</span><span class="p">()</span>
</code></pre></div>


<ul>
<li>Description: Print the internal file tree.</li>
</ul>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../container/" title="Job Scheduling" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Job Scheduling
              </span>
            </div>
          </a>
        
        
          <a href="../rpc/" title="RPC" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                RPC
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 Kaifeng Chen
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/kfrancischen" target="_blank" rel="noopener" title="github" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://www.linkedin.com/in/kaifeng-chen-b37a2b69/" target="_blank" rel="noopener" title="linkedin" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:".."}})</script>
      
    
  </body>
</html>